<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enregistrement Actions</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #2a2a2a; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üß™ Test Enregistrement des Actions</h1>
    
    <div class="test-section">
        <h2>üìã Test 1: V√©rification localStorage</h2>
        <button onclick="testLocalStorage()">Tester localStorage</button>
        <button onclick="clearLocalStorage()">Vider localStorage</button>
        <div id="localStorage-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìã Test 2: Simulation d'ajout d'action</h2>
        <button onclick="simulateAddStep()">Simuler ajout d'action</button>
        <button onclick="simulateStartRound()">Simuler d√©marrage ronde</button>
        <button onclick="simulateStopRound()">Simuler arr√™t ronde</button>
        <div id="simulation-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìã Test 3: V√©rification des donn√©es sauvegard√©es</h2>
        <button onclick="checkSavedRounds()">V√©rifier rondes sauvegard√©es</button>
        <div id="saved-rounds-log" class="log"></div>
    </div>

    <script>
        let testRoundData = null;
        let isRecording = false;

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function testLocalStorage() {
            log('localStorage-log', 'üß™ Test localStorage...', 'info');
            
            try {
                // Tester l'acc√®s au localStorage
                localStorage.setItem('test_key', 'test_value');
                const value = localStorage.getItem('test_key');
                
                if (value === 'test_value') {
                    log('localStorage-log', '‚úÖ localStorage fonctionne correctement', 'success');
                    localStorage.removeItem('test_key');
                } else {
                    log('localStorage-log', '‚ùå localStorage ne fonctionne pas', 'error');
                }

                // V√©rifier les rondes existantes
                const existingRounds = localStorage.getItem('carnet_securite_rounds');
                log('localStorage-log', `üì¶ Rondes existantes: ${existingRounds || 'aucune'}`, 'info');

            } catch (error) {
                log('localStorage-log', `‚ùå Erreur localStorage: ${error.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('carnet_securite_rounds');
            log('localStorage-log', 'üóëÔ∏è localStorage vid√©', 'success');
        }

        function simulateStartRound() {
            log('simulation-log', 'üöÄ Simulation d√©marrage ronde...', 'info');
            
            testRoundData = {
                id: `test_round_${Date.now()}`,
                name: `Test Ronde ${new Date().toLocaleString()}`,
                startTime: Date.now(),
                steps: [],
                totalSteps: 0,
                isCompleted: false
            };
            
            isRecording = true;
            log('simulation-log', `‚úÖ Ronde cr√©√©e: ${testRoundData.name}`, 'success');
            log('simulation-log', `üìä ID: ${testRoundData.id}`, 'info');
        }

        function simulateAddStep() {
            if (!isRecording || !testRoundData) {
                log('simulation-log', '‚ùå Pas de ronde en cours', 'error');
                return;
            }

            log('simulation-log', '‚ûï Simulation ajout d\'action...', 'info');

            const newStep = {
                id: `step_${Date.now()}_${Math.random()}`,
                timestamp: Date.now(),
                action: 'Droite',
                direction: 'right',
                steps: 15,
                distance: 45.2,
                location: '',
                notes: ''
            };

            testRoundData.steps.push(newStep);
            testRoundData.totalSteps = testRoundData.steps.length;

            log('simulation-log', `‚úÖ Action ajout√©e: ${newStep.action} (${newStep.steps} pas, ${newStep.distance}m)`, 'success');
            log('simulation-log', `üìä Total actions: ${testRoundData.steps.length}`, 'info');

            // Sauvegarder dans localStorage
            try {
                const existingRounds = JSON.parse(localStorage.getItem('carnet_securite_rounds') || '[]');
                const existingIndex = existingRounds.findIndex(r => r.id === testRoundData.id);
                
                if (existingIndex >= 0) {
                    existingRounds[existingIndex] = testRoundData;
                } else {
                    existingRounds.push(testRoundData);
                }
                
                localStorage.setItem('carnet_securite_rounds', JSON.stringify(existingRounds));
                log('simulation-log', 'üíæ Ronde sauvegard√©e dans localStorage', 'success');
            } catch (error) {
                log('simulation-log', `‚ùå Erreur sauvegarde: ${error.message}`, 'error');
            }
        }

        function simulateStopRound() {
            if (!isRecording || !testRoundData) {
                log('simulation-log', '‚ùå Pas de ronde en cours', 'error');
                return;
            }

            log('simulation-log', 'üõë Simulation arr√™t ronde...', 'info');

            testRoundData.endTime = Date.now();
            testRoundData.duration = testRoundData.endTime - testRoundData.startTime;
            testRoundData.isCompleted = true;

            // Sauvegarder la ronde finale
            try {
                const existingRounds = JSON.parse(localStorage.getItem('carnet_securite_rounds') || '[]');
                const existingIndex = existingRounds.findIndex(r => r.id === testRoundData.id);
                
                if (existingIndex >= 0) {
                    existingRounds[existingIndex] = testRoundData;
                } else {
                    existingRounds.push(testRoundData);
                }
                
                localStorage.setItem('carnet_securite_rounds', JSON.stringify(existingRounds));
                log('simulation-log', 'üíæ Ronde finale sauvegard√©e', 'success');
                log('simulation-log', `üìä Actions totales: ${testRoundData.steps.length}`, 'info');
                log('simulation-log', `‚è±Ô∏è Dur√©e: ${Math.round(testRoundData.duration / 1000)}s`, 'info');
            } catch (error) {
                log('simulation-log', `‚ùå Erreur sauvegarde finale: ${error.message}`, 'error');
            }

            isRecording = false;
            testRoundData = null;
        }

        function checkSavedRounds() {
            log('saved-rounds-log', 'üîç V√©rification des rondes sauvegard√©es...', 'info');
            
            try {
                const savedRounds = JSON.parse(localStorage.getItem('carnet_securite_rounds') || '[]');
                log('saved-rounds-log', `üìä Nombre de rondes: ${savedRounds.length}`, 'info');
                
                savedRounds.forEach((round, index) => {
                    log('saved-rounds-log', `\nüìã Ronde ${index + 1}:`, 'info');
                    log('saved-rounds-log', `  - Nom: ${round.name}`, 'info');
                    log('saved-rounds-log', `  - ID: ${round.id}`, 'info');
                    log('saved-rounds-log', `  - Termin√©e: ${round.isCompleted ? 'Oui' : 'Non'}`, 'info');
                    log('saved-rounds-log', `  - Actions: ${round.steps ? round.steps.length : 0}`, 'info');
                    
                    if (round.steps && round.steps.length > 0) {
                        log('saved-rounds-log', `  - D√©tail des actions:`, 'info');
                        round.steps.forEach((step, stepIndex) => {
                            log('saved-rounds-log', `    ${stepIndex + 1}. ${step.action} (${step.steps} pas, ${step.distance || 0}m)`, 'info');
                        });
                    }
                });
                
                if (savedRounds.length === 0) {
                    log('saved-rounds-log', '‚ö†Ô∏è Aucune ronde sauvegard√©e', 'error');
                }
                
            } catch (error) {
                log('saved-rounds-log', `‚ùå Erreur lecture: ${error.message}`, 'error');
            }
        }

        // Test automatique au chargement
        window.onload = function() {
            log('localStorage-log', 'üöÄ Page de test charg√©e', 'success');
            testLocalStorage();
        };
    </script>
</body>
</html>
