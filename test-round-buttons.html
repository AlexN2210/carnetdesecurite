<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Boutons de Ronde</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #111827; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: #1f2937; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .error { border-left-color: #ef4444; }
        .success { border-left-color: #10b981; }
        .warning { border-left-color: #f59e0b; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .log { background: #000; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; margin: 10px 0; }
        .result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success-result { background: #065f46; }
        .error-result { background: #7f1d1d; }
        .warning-result { background: #92400e; }
        .info-result { background: #1e40af; }
        .action-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        .action-btn { padding: 15px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; }
        .action-btn:hover { opacity: 0.8; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .marche { background: #10b981; }
        .droite { background: #3b82f6; }
        .gauche { background: #3b82f6; }
        .pointeaux { background: #ef4444; }
        .porte { background: #8b5cf6; }
        .etage { background: #6366f1; }
        .position { background: #ec4899; }
        .control-panel { background: #374151; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .recording { background: #065f46; }
        .stopped { background: #7f1d1d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Boutons de Ronde</h1>
        
        <div class="section">
            <h2>1. Contr√¥les de Ronde</h2>
            <div class="control-panel">
                <button onclick="startRound()" id="startBtn">üöÄ D√©marrer Ronde</button>
                <button onclick="stopRound()" id="stopBtn" disabled>‚èπÔ∏è Arr√™ter Ronde</button>
                <button onclick="clearAll()">üóëÔ∏è Effacer Tout</button>
            </div>
            
            <div id="status" class="status stopped">
                Statut: Arr√™t√©
            </div>
        </div>

        <div class="section">
            <h2>2. Boutons d'Action</h2>
            <p>Cliquez sur les boutons pour tester l'ajout d'actions :</p>
            
            <div class="action-buttons">
                <button class="action-btn marche" onclick="testAction('Marche', 'forward')" id="marcheBtn" disabled>üö∂‚Äç‚ôÇÔ∏è Marche</button>
                <button class="action-btn droite" onclick="testAction('Droite', 'right')" id="droiteBtn" disabled>‚Ü™Ô∏è Droite</button>
                <button class="action-btn gauche" onclick="testAction('Gauche', 'left')" id="gaucheBtn" disabled>‚Ü©Ô∏è Gauche</button>
                <button class="action-btn pointeaux" onclick="testAction('Pointeaux')" id="pointeauxBtn" disabled>üéØ Pointeaux</button>
                <button class="action-btn porte" onclick="testAction('Porte')" id="porteBtn" disabled>üö™ Porte</button>
                <button class="action-btn etage" onclick="testAction('√âtage')" id="etageBtn" disabled>üè¢ √âtage</button>
                <button class="action-btn position" onclick="testAction('Position')" id="positionBtn" disabled>üìç Position</button>
                <button class="action-btn marche" onclick="testAction('Tout droit', 'forward')" id="toutDroitBtn" disabled>‚¨ÜÔ∏è Tout droit</button>
            </div>
        </div>

        <div class="section">
            <h2>3. R√©sultats</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>4. Logs de d√©bogage</h2>
            <div id="debug-log" class="log">Pr√™t pour les tests...\n</div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let roundData = null;
        let actions = [];
        let stepCount = 0;

        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                error: '#ef4444',
                success: '#10b981', 
                warning: '#f59e0b',
                info: '#6b7280'
            };
            logDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const addResult = (message, type) => {
            const element = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}-result`;
            resultDiv.textContent = message;
            element.appendChild(resultDiv);
        };

        const clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        const clearLog = () => {
            document.getElementById('debug-log').innerHTML = 'Logs effac√©s...\n';
        };

        const updateStatus = () => {
            const statusDiv = document.getElementById('status');
            if (isRecording) {
                statusDiv.textContent = `Statut: Enregistrement (${actions.length} actions)`;
                statusDiv.className = 'status recording';
            } else {
                statusDiv.textContent = 'Statut: Arr√™t√©';
                statusDiv.className = 'status stopped';
            }
        };

        const updateButtons = () => {
            const buttons = ['marcheBtn', 'droiteBtn', 'gaucheBtn', 'pointeauxBtn', 'porteBtn', 'etageBtn', 'positionBtn', 'toutDroitBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.disabled = !isRecording;
            });
            
            document.getElementById('startBtn').disabled = isRecording;
            document.getElementById('stopBtn').disabled = !isRecording;
        };

        // Simulation de la fonction addStep
        const addStep = (action, direction) => {
            log(`üöÄ addStep appel√©e avec: action=${action}, direction=${direction}, isRecording=${isRecording}, roundData=${!!roundData}`);
            
            if (!isRecording || !roundData) {
                log(`‚ùå addStep annul√©e: isRecording=${isRecording}, roundData=${!!roundData}`);
                return;
            }

            log(`üîÑ Ajout d'√©tape: ${action} ${direction || ''} - Pas actuels: ${stepCount}`);

            // TOUJOURS ajouter une √©tape pour toutes les actions manuelles
            const isManualAction = direction !== 'automatique';
            const isStepAction = action === 'Marche' || action === 'Tout droit' || action === 'Reculer' || 
                                action === 'Droite' || action === 'Gauche';

            // Incr√©menter le compteur d'√©tapes pour TOUTES les actions manuelles
            if (isManualAction) {
                stepCount += 1;
                log(`üìà Compteur d'√©tapes incr√©ment√©: ${stepCount}`);
            }

            // Pour les actions de marche, utiliser 5 pas par d√©faut
            // Pour les autres actions, mettre 0 pas
            let stepCountForAction = 0;
            if (isStepAction) {
                stepCountForAction = 5; // Nombre de pas par d√©faut
            }
            // Pour les autres actions (Pointeaux, Porte, √âtage, etc.), stepCount reste √† 0
            
            const newStep = {
                id: `step_${Date.now()}_${Math.random()}`,
                timestamp: Date.now(),
                action,
                direction,
                steps: stepCountForAction,
                location: null,
                notes: ''
            };

            log(`üìù Nouvelle √©tape cr√©√©e:`, 'info');
            log(JSON.stringify(newStep, null, 2), 'info');

            actions.push(newStep);
            
            // Calculer le total des pas r√©els (seulement pour les actions de marche)
            const realStepCount = actions
                .filter(step => step.action === 'Marche' || step.action === 'Tout droit' || step.action === 'Reculer' || 
                               step.action === 'Droite' || step.action === 'Gauche')
                .reduce((total, step) => total + (step.steps || 0), 0);
            
            log(`üìä Nouvelle √©tape: ${action} - Pas: ${stepCountForAction} - Total pas r√©els: ${realStepCount}`);
            log(`üìä Total √©tapes: ${actions.length} (toutes actions confondues)`);

            // Log d√©taill√© pour le d√©bogage
            log(`‚úÖ √âtape ajout√©e: ${action} ${direction || ''} - Pas: ${stepCountForAction} - Total √©tapes: ${actions.length} - Total pas: ${realStepCount}`);
            log('üìã Toutes les √©tapes actuelles: ' + actions.map((s, i) => `${i + 1}. ${s.action} (${s.steps} pas)`).join(', '));

            // Mettre √† jour l'affichage
            updateResults();
        };

        const testAction = (action, direction) => {
            log(`üîò Bouton cliqu√©: ${action} ${direction || ''}`);
            log(`üîò isRecording: ${isRecording}, roundData:`, roundData);
            addStep(action, direction);
        };

        const startRound = () => {
            log('üöÄ D√©marrage de la ronde...');
            roundData = {
                id: `round_${Date.now()}`,
                name: `Ronde ${new Date().toLocaleString()}`,
                startTime: Date.now(),
                steps: [],
                totalSteps: 0,
                isCompleted: false
            };
            
            log('üìù Nouvelle ronde cr√©√©e:', 'info');
            log(JSON.stringify(roundData, null, 2), 'info');
            
            isRecording = true;
            actions = [];
            stepCount = 0;
            
            log('‚úÖ Ronde d√©marr√©e - isRecording=true, roundData initialis√©');
            updateStatus();
            updateButtons();
            clearResults();
        };

        const stopRound = () => {
            log('‚èπÔ∏è Arr√™t de la ronde...');
            isRecording = false;
            
            log('üíæ Sauvegarde de la ronde:', 'info');
            log(`üìä Total actions: ${actions.length}`);
            log('üìã Actions sauvegard√©es: ' + actions.map((s, i) => `${i + 1}. ${s.action} (${s.steps} pas)`).join(', '));
            
            updateStatus();
            updateButtons();
            updateResults();
        };

        const clearAll = () => {
            isRecording = false;
            roundData = null;
            actions = [];
            stepCount = 0;
            clearResults();
            clearLog();
            updateStatus();
            updateButtons();
            log('üóëÔ∏è Tout effac√©');
        };

        const updateResults = () => {
            clearResults();
            
            addResult(`Total d'actions: ${actions.length}`, 'info');
            addResult(`Total de pas: ${actions.reduce((total, step) => total + (step.steps || 0), 0)}`, 'info');
            
            const actionTypes = {};
            actions.forEach(step => {
                actionTypes[step.action] = (actionTypes[step.action] || 0) + 1;
            });
            
            Object.entries(actionTypes).forEach(([action, count]) => {
                addResult(`${action}: ${count} fois`, 'success');
            });
            
            addResult('D√©tail des actions:', 'info');
            actions.forEach((step, index) => {
                addResult(`${index + 1}. ${step.action} ${step.direction ? `(${step.direction})` : ''} - ${step.steps} pas`, 'info');
            });
        };

        // Auto-test au chargement
        window.addEventListener('load', () => {
            log('Page de test charg√©e', 'success');
            updateStatus();
            updateButtons();
        });
    </script>
</body>
</html>
